begin tran 
--rollback

IF OBJECT_ID ('TEMPDB..#TEMP1') IS NOT NULL DROP TABLE #TEMP1

SELECT  C.NF_COMPRA
	   ,C.ENTIDADE
       ,C.PROCESSAR
	   ,B.RECEBIMENTO_APROVACAO

INTO #TEMP1
FROM APROVACOES_RECEB_VOLUMES        A WITH(NOLOCK) 
JOIN APROVACOES_RECEB_VOLUMES_ITENS  B WITH(NOLOCK) ON A.RECEBIMENTO_APROVACAO = B.RECEBIMENTO_APROVACAO 
JOIN NF_COMPRA                       C WITH(NOLOCK) ON B.RECEBIMENTO = C.RECEBIMENTO 

WHERE C.PROCESSAR = 'N' --AND C.MOVIMENTO = '16/03/2021'
  --AND B.RECEBIMENTO_APROVACAO IN (5388,5436)
  --SELECT RECEBIMENTO_APROVACAO FROM #TEMP1

DECLARE @RECEBIMENTO_APROVACAO NUMERIC(15)

DECLARE PROCESSAMENTO CURSOR

FOR

SELECT RECEBIMENTO_APROVACAO FROM #TEMP1

OPEN PROCESSAMENTO

FETCH NEXT FROM PROCESSAMENTO INTO @RECEBIMENTO_APROVACAO

WHILE @@FETCH_STATUS = 0

BEGIN 

EXEC USP_GRAVACAO_FINAL_APROVACAO_RECEB @RECEBIMENTO_APROVACAO 

FETCH NEXT FROM PROCESSAMENTO INTO @RECEBIMENTO_APROVACAO

END

CLOSE PROCESSAMENTO

DEALLOCATE PROCESSAMENTO

