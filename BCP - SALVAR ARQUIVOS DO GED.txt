CREATE PROCEDURE USP_GERAR_DOCUMENTOS_GED ( @PROPOSTA NUMERIC(15) )  AS     
   
    
--DECLARE @PROPOSTA NUMERIC(15) = 31    
DECLARE @CAMINHO VARCHAR(500) = CONCAT( 'C:\pbs\GED\PROPOSTA_',@PROPOSTA )    
    
    
DECLARE @COMANDO_PASTA VARCHAR(400) = CONCAT( 'mkdir ',@CAMINHO)    
    
EXEC master.dbo.xp_cmdshell @COMANDO_PASTA , NO_OUTPUT   
    
DECLARE @GED NUMERIC(15)    
DECLARE @NOME_ARQUIVO VARCHAR(500)    
DECLARE @COMANDO_BCP VARCHAR(4000)    
    
DECLARE DownloadDocs CURSOR FAST_FORWARD FOR    
    
    SELECT B.GED , DBO.FN_SUBSTITUIR_ESPACOS( CAST(DBO.ZEROS( ROW_NUMBER() OVER(ORDER BY C.PROPOSTA_DOCUMENTO) , 3) AS VARCHAR) + '-'   
         + D.DESCRICAO + UPPER( DBO.[UDF_ATRIBUTOS_ARQUIVO](B.NOME_ARQUIVO, 3) ) ) AS ARQUIVO    
  
    FROM PROPOSTAS            A WITH(NOLOCK)    
 JOIN PROPOSTAS_DOCUMENTOS C WITH(NOLOCK)ON A.PROPOSTA = C.PROPOSTA  
    JOIN GED                  B WITH(NOLOCK)ON 457876 = B.FORMULARIO_ORIGEM AND 457697 = B.TAB_MASTER_ORIGEM AND C.CADASTRO_DOCUMENTO = B.REG_MASTER_ORIGEM      
 JOIN CADASTROS_DOCUMENTOS D WITH(NOLOCK)ON D.CADASTRO_DOCUMENTO = C.CADASTRO_DOCUMENTO  
   WHERE A.PROPOSTA = @PROPOSTA    
    
OPEN DownloadDocs     
    
FETCH NEXT FROM DownloadDocs INTO @GED , @NOME_ARQUIVO    
    
WHILE @@FETCH_STATUS = 0     
BEGIN    
    
 SET @COMANDO_BCP = CONCAT( 'BCP "SELECT CONTEUDO FROM PBS_PROHOSPITAL_DADOS.DBO.GED WHERE GED = ' , @GED , '" QUERYOUT ', @CAMINHO , '\' , @NOME_ARQUIVO , ' -T -N' )    
    
 EXEC master.dbo.xp_cmdshell @COMANDO_BCP , NO_OUTPUT   
    
FETCH NEXT FROM DownloadDocs INTO @GED , @NOME_ARQUIVO    
    
END    
    
CLOSE DownloadDocs    
DEALLOCATE DownloadDocs    